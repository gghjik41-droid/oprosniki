<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Опросник v4.5 ЭТАЛОН (Короткий)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #eceff1; margin: 0; color: #333; }
        .container { 
    display: flex; 
    flex-wrap: wrap; /* Разрешаем перенос на новую строку */
    width: 100%; 
	align-items: flex-start;
    gap: 15px; 
    padding: 10px; 
    box-sizing: border-box;
	position: relative;
}
        .form-side { 
    flex: 1 1 500px; /* Минимум 500px, если места меньше — прыгает вниз */
    background: white; 
    padding: 20px; 
    border-radius: 12px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
    overflow-y: visible; /* Убираем внутреннюю прокрутку для мобилок */
}
        .result-side { 
    flex: 1 1 400px; /* Минимум 400px */
    display: flex; 
    flex-direction: column; 
    gap: 10px; 
    height: auto; 
/* Настройки липкости */
    position: -webkit-sticky; /* Для Safari */
    position: sticky;
    top: 20px; /* Расстояние от верха экрана */
    
    /* Ограничиваем высоту, чтобы внутри блока работал свой скролл, 
       если текст результата станет очень длинным */
    max-height: calc(100vh - 40px);
}
@media (max-width: 600px) {
    /* 1. Липкая панель кнопок — теперь максимально компактная */
    .buttons {
        position: sticky;
        top: 0;
        z-index: 100;
        background: #eceff1;
        padding: 8px 0;
        display: flex;
        gap: 8px;
        flex-direction: row; /* Кнопки в ряд */
    }

    .btn {
        flex: 1; /* Кнопки одинаковой ширины */
        padding: 10px 5px;
        font-size: 12px;
    }

    /* 2. Компактные заголовки */
    h2 {
        font-size: 1.1rem;
        margin: 10px 0;
        text-align: center;
    }

    .result-side h2 {
        font-size: 0.9rem;
        margin: 5px 0;
    }

    /* 3. Оптимизация полей ввода (меньше отступов) */
    .container {
        padding: 5px;
    }

    .form-side {
        padding: 15px;
        flex: 1 1 100%; /* Занимает всю ширину */
    }

    .form-group {
        margin-bottom: 8px;
    }

    .form-group label {
        font-size: 13px;
        margin-bottom: 2px;
    }

    input, select, textarea {
        padding: 10px; /* Удобно нажимать пальцем */
        font-size: 16px; /* Чтобы iPhone не приближал экран при вводе */
    }

    /* 4. Поле вывода результата */
    #output {
        min-height: 250px;
        font-size: 13px;
    }
}
        
        h2 { margin-top: 0; color: #781919; border-bottom: 2px solid #9e3636; padding-bottom: 10px; font-size: 18px; text-transform: uppercase; }
        .hint { font-size: 12px; color: #2e7d32; margin-bottom: 5px; display: block; line-height: 1.4; background: #f1f8e9; padding: 6px 10px; border-left: 3px solid #4caf50; white-space: pre-wrap; }
        .section-title { background: #e8f5e9; padding: 8px 12px; font-weight: bold; margin: 25px 0 15px 0; border-left: 5px solid #2e7d32; font-size: 14px; }
        
        .field-group { margin-bottom: 25px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; position: relative; }
        label { display: block; font-weight: 700; margin-bottom: 4px; font-size: 13px; color: #263238; text-decoration: underline; }
        
        input, textarea { width: 100%; padding: 10px; border: 1px solid #cfd8dc; border-radius: 6px; box-sizing: border-box; font-size: 16px; background: #fafafa; display: block; }
        textarea.auto-height { min-height: 38px; height: 38px; resize: none; overflow: hidden; line-height: 1.4; }

        #z_text { min-height: 80px; resize: vertical; }
        .sticky-header { position: sticky; top: -25px; background: white; z-index: 10; padding-bottom: 10px; border-bottom: 2px solid #eee; margin-bottom: 15px; }
        #output { flex-grow: 1; padding: 15px; border-radius: 10px; border: 1px solid #b0bec5; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.2; background: #fff; white-space: pre-wrap; overflow-y: auto; width: 100%; min-height: 600px;}
        
        .add-field-btn { font-size: 10px; color: #1976d2; cursor: pointer; text-decoration: none; display: inline-block; margin-top: 5px; font-weight: bold; }
        .dynamic-field-wrapper { position: relative; margin-top: 10px; display: flex; align-items: center; gap: 5px; }
        .dynamic-field { border-left: 2px dashed #1976d2 !important; background: #f1f8e9 !important; flex-grow: 1; }
        .remove-btn { color: #f44336; cursor: pointer; font-weight: bold; font-size: 18px; padding: 0 5px; user-select: none; }

        .buttons { display: flex; gap: 10px; align-items: center; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-copy { background: #1976d2; color: white; }
        .btn-clear { background: #f44336; color: white; width: 100px; flex: none; }
        #save-status { font-size: 11px; color: #999; margin-left: auto; }
    </style>
</head>
<body>

<div class="container">
    <div class="form-side" id="form_container">
        <div class="sticky-header">
            <div class="field-group" id="z_container" style="margin-bottom: 15px;">
<div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 5px;">
    <label style="margin-bottom: 0; display: inline-block;">ЗАЯВКА</label>
    
    <button id="z_edit_btn" onclick="editZ()" style="
        display: none; 
        width: auto !important; /* Запрещаем растягивание */
        flex: none; 
        background: #90a4ae; 
        color: white; 
        border: none; 
        border-radius: 4px; 
        padding: 2px 8px; 
        font-size: 10px; 
        line-height: 1.2;
        height: 20px; 
        cursor: pointer; 
        text-transform: none;
        margin: 0;
    ">Изм.</button>
</div>
    
    <textarea id="z_text" placeholder="Вставьте текст заявки и нажмите OK..." style="min-height: 120px;"></textarea>
    
    <div id="z_fixed" style="display: none; background: #f1f8e9; padding: 10px; border-radius: 8px; border: 1px solid #c8e6c9;">
        <div id="z_value" style="
    font-size: 12px; 
    color: #1b5e20; 
    white-space: pre-wrap; 
    line-height: 1.5em;       /* Четкая высота строки */
    max-height: 7.5em;        /* Высота ровно на 5 строк (1.5 * 5) */
    overflow-y: auto; 
    scroll-snap-type: y mandatory; /* Включаем примагничивание по вертикали */
    padding-right: 5px;
"></div>
    </div>
    
    <button id="z_confirm_btn" onclick="fixZ()" style="margin-top: 8px; background: #4caf50; color: white; border: none; border-radius: 6px; padding: 10px; width: 100%; cursor: pointer; font-weight: bold;">ОК</button>
</div>
        </div>

        <h2>Старики, Инвалиды, Потеря памяти</h2>

        <div class="field-group">
            <label>Позывной, дата и время прозвона:</label>
            <input type="text" id="z_call" data-p=" " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>
		
		<div class="section-title">Общая часть:</div>

        <div class="field-group">
            <span class="hint">ФИО заявителя, номер телефона в формате 81110000000, родство
Дополнительный номер для связи с заявителем (соседи, друзья, родственники).</span>
            <label>Прозвон заявителя:</label>
            <textarea class="auto-height" data-p="Прозвон заявителя: " oninput="adjustAndSync(this)"></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">ФИО БВП (любая смена ФИО). Сверяем ФИО письменно!
Дата рождения и возраст. Сверяем письменно!</span>
            <label>Пропал:</label>
            <textarea class="auto-height" data-p="Пропал: " oninput="adjustAndSync(this)"></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Коротко об обстоятельствах: адрес пропажи (город, район, улица, № дома, № подъезда, № квартиры), дата, время.</span>
            <textarea class="auto-height" data-p="" oninput="adjustAndSync(this)" placeholder="Обстоятельства (свободная форма)..."></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Здоровье/медикаменты/что будет, если не принять. Есть ли диагноз/какой/инвалидность. Когда началось/как проявляется заболевание/Есть ли внешние проявления заболевания/странности поведения. Если проблемы с памятью – подробно, как проявляются, что помнит, что не помнит. Как ориентируется в пространстве. Как слышит/видит/ходит, ориентир во времени и пространстве.
Назовет ли себя, свое фио, адрес, телефон родственников. Если да, проверяли ли.</span>
            <label>Здоровье:</label>
            <textarea class="auto-height" data-p="Здоровье: " oninput="adjustAndSync(this)"></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Приметы (рост, телосложение, цвет и длина волос, цвет глаз, носит ли бороду/усы/очки).</span>
            <label>Приметы:</label>
            <input type="text" data-p="Приметы: " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Особые (есть ли шрамы, тату, заметные родинки/родимые пятна, особенности зубов, походки, отсутствие пальцев и тп).</span>
            <label>Особые:</label>
            <input type="text" data-p="Особые: " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Одежда/обувь/головной убор (цвет, материал, надписи).</span>
            <label>Одежда:</label>
            <input type="text" data-p="Одежда: " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Что с собой (паспорт, наличные деньги, банковские карты, проездные, ключи, украшения), если нет, так и пишем «паспорт – нет, наличные - нет» и т.д.</span>
            <label>С собой:</label>
            <input type="text" data-p="С собой: " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Телефон потеряшки (даже если остался дома), на кого зарегистрирована симка, марка и модель. Если сим на заявителя - попросить взять выписку звонков. В сети ли сейчас телефон. Когда был в сети в последний раз. Спрашиваем все номера.</span>
            <label>Телефон БВП:</label>
            <input type="text" data-p="Телефон БВП " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Где и с кем, сколько по времени проживает/зарегистрирован(а)/пропал(а).</span>
            <label>Проживает/прописан/пропал:</label>
            <input type="text" data-p="Проживает/прописан/пропал: " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Пропадал(а) ли ранее, когда/как и где находили.</span>
            <textarea class="auto-height" data-p="" oninput="adjustAndSync(this)" placeholder="Пропадал ли ранее..."></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">ОБСТОЯТЕЛЬСТВА ПРОПАЖИ подробно!!! Дата и время пропажи (во сколько стал недоступен/перестал отвечать на телефон). Что предпринимали для поиска (были на месте пропажи, звонили куда-то, кому-то).</span>
            <label>Подробности:</label>
            <textarea class="auto-height" data-p="Подробности: " oninput="adjustAndSync(this)"></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Полиция: ФИО заявителя в полицию, дата подачи заявления, название ОВД (адрес ОВД), телефон дежурной части, номер талона, номер КУСП, если есть – телефон оперативного сотрудника. Если у заявителя нет этой информации – просим узнать. Оговариваем срок подачи заявление в полицию до 3-х суток от момента поступлении заявки, в противном случае мы вынуждены будем отказать в поиске. Обязательно пишем в прозвоне, до какого срока заявитель обязуется подать заявление в полицию.
Если заявление в полицию не подано, оговариваем срок до 3-х суток от момента поступления заявки, в противном случае мы вынуждены будем отказать в поиске. Обязательно пишем в прозвоне, до какого срока заявитель обязуется подать заявление в полицию.</span>
            <label>ЗВП:</label>
            <textarea class="auto-height" data-p="ЗВП " oninput="adjustAndSync(this)"></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="section-title">Специальная часть:</div>

        <div class="field-group">
            <span class="hint">Семейное положение/ситуация в семье/предыдущие браки/дети от прошлых браков/близкие родственники/к кому мог поехать/знают ли они о пропаже. Родственники в других городах.</span>
            <label>Семья:</label>
            <textarea class="auto-height" data-p="Семья: " oninput="adjustAndSync(this)"></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Все прежние места жительства (адрес, описание дома).</span>
            <textarea class="auto-height" data-p="" oninput="adjustAndSync(this)" placeholder="Прежние места жительства..."></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Есть ли дача, как часто там бывает, знает ли дорогу, как добирается.</span>
            <label>Дача/гараж:</label>
            <input type="text" data-p="Дача/гараж - " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Передвигается ли самостоятельно (куда, каким способом, как часто) привычные маршруты, места привязки.</span>
            <label>Места привязки:</label>
            <input type="text" data-p="Места привязки: " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Общественный транспорт: умеет ли пользоваться, каким пользуется, боится/не боится, как ориентируется.</span>
            <textarea class="auto-height" data-p="" oninput="adjustAndSync(this)" placeholder="Общественный транспорт..."></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Прежние места работы/кем, где, сколько уже не работает/вспоминает ли о работе.</span>
            <label>Работа:</label>
            <input type="text" data-p="Работа: " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Вспоминает ли кого-то из погибших родственников, где похоронены, как часто ездит на кладбище, стремится ли туда.</span>
            <textarea class="auto-height" data-p="" oninput="adjustAndSync(this)" placeholder="Погибшие родственники..."></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Куда стремится/просится/кого зовет/вспоминает.</span>
            <textarea class="auto-height" data-p="" oninput="adjustAndSync(this)" placeholder="Куда стремится..."></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Отдых/что делает в свободное время/интересы/увлечения.</span>
            <textarea class="auto-height" data-p="" oninput="adjustAndSync(this)" placeholder="Отдых/увлечения..."></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Коллеги/друзья/круг общения.</span>
            <label>Круг общения:</label>
            <input type="text" data-p="Круг общения: " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Особенности характера/поведения/коммуникабельность. Реакция на незнакомых людей/на предложение помощи.</span>
            <label>Характер:</label>
            <textarea class="auto-height" data-p="Характер: " oninput="adjustAndSync(this)"></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Обычный ритм жизни/режим дня/режим сна.</span>
            <label>Режим дня:</label>
            <input type="text" data-p="Режим дня: " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <label>Религия:</label>
            <input type="text" data-p="Религия - " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Вредные привычки: курение, алкоголь (как часто, в одиночестве или с кем-то, дома или где-то), если может уйти в запой – на как долго, выходит самостоятельно или с помощью, наркотики.</span>
            <textarea class="auto-height" data-p="" oninput="adjustAndSync(this)" placeholder="Вредные привычки..."></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Чего боится/страхи.</span>
            <label>Страхи:</label>
            <input type="text" data-p="Страхи: " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <label>Проблемы с законом:</label>
            <input type="text" data-p="Проблемы с законом - " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <label>Кредиты/долги:</label>
            <input type="text" data-p="Кредиты/долги - " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Мысли о суициде – если нет, подробно, что дословно сказал заявитель, если да, из-за чего, как давно, что говорит о причинах, были ли ранее попытки/когда/способ, что говорит о способе/месте/времени.</span>
            <label>Суицид:</label>
            <textarea class="auto-height" data-p="Суицид - " oninput="adjustAndSync(this)"></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Не служит ли в армии в настоящий момент, не скрывается от службы. СВО.</span>
            <label>Воинская обязанность:</label>
            <input type="text" data-p="Воинская обязанность: " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Что изменилось накануне пропажи/ссоры/конфликты/необычное.</span>
            <textarea class="auto-height" data-p="Накануне " oninput="adjustAndSync(this)"></textarea>
			<label>Накануне:</label>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Контакты друзей/знакомых в формате (обязательно хотя бы один доп. контакт для связи с заявителем!):</span>
            <label>Контакты:</label>
            <textarea class="auto-height" data-p="Контакты: " oninput="adjustAndSync(this)"></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Пояснить родным, что информация будет размещена в интернете. (ИНОГДА БЫВАЮТ ПРОТИВ РАЗМЕЩЕНИЯ)</span>
            <label>Согласие на орки:</label>
            <input type="text" data-p="Согласие на орки - " oninput="update()" placeholder="Да/Нет">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>
    </div>

    <div class="result-side">
        <div class="buttons">
            <button class="btn-copy" onclick="copyText()">Скопировать</button>
            <button class="btn-clear" onclick="clearAllData()">Очистить</button>
            <span id="save-status">Сохранено</span>
        </div>
        <textarea id="output" readonly></textarea>
    </div>
</div>

<script>
    const STORAGE_KEY = 'pso_survey_stariki_v43';

    function adjustHeight(el) {
        el.style.height = '38px';
        el.style.height = (el.scrollHeight) + 'px';
    }

    function adjustAndSync(el) {
        adjustHeight(el);
        update();
    }

    function addNewField(btn, val = "") {
        const wrapper = document.createElement('div');
        wrapper.className = 'dynamic-field-wrapper';
        const input = document.createElement('textarea');
        input.className = 'dynamic-field auto-height';
        input.placeholder = 'Дополнительная информация...';
        input.setAttribute('data-dynamic', 'true');
        input.setAttribute('data-p', '');
        input.value = val;
        input.oninput = function() { adjustAndSync(this); };
        const removeBtn = document.createElement('span');
        removeBtn.className = 'remove-btn';
        removeBtn.innerHTML = '×';
        removeBtn.onclick = function() { wrapper.remove(); update(); };
        wrapper.appendChild(input);
        wrapper.appendChild(removeBtn);
        btn.parentNode.insertBefore(wrapper, btn);
        if (!val) input.focus();
        adjustHeight(input);
    }

    function update() {
        let lines = [];
        const zText = document.getElementById('z_text').value.trim();
        //if (zText !== "") lines.push("ЗАЯВКА\n" + zText + "\n");

        const allInputs = document.querySelectorAll('.form-side input, .form-side textarea');
        allInputs.forEach(el => {
            if (el.id === 'z_text' || el.id === 'output') return;
            const val = el.value.trim();
            if (val !== "") {
                const prefix = el.getAttribute('data-p') || "";
                if (el.id === 'z_call') {
                    lines.push(prefix + val + "\n");
                } else {
                    lines.push(prefix + val);
                }
            }
        });

        document.getElementById('output').value = lines.join('\n').replace(/\n{3,}/g, '\n\n').trim();
        saveData();
    }

    function saveData() {
        const data = { static: {}, dynamic: [] };
        document.querySelectorAll('input, textarea').forEach((el, index) => {
            if (el.id === 'output') return;
            if (el.hasAttribute('data-dynamic')) {
                const parentGroup = el.closest('.field-group');
                const groupIdx = Array.from(document.querySelectorAll('.field-group')).indexOf(parentGroup);
                data.dynamic.push({ groupIdx: groupIdx, value: el.value });
            } else {
                data.static[el.id || 'idx_' + index] = el.value;
            }
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        document.getElementById('save-status').innerText = "Сохранено " + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function loadData() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const data = JSON.parse(raw);
        document.querySelectorAll('input, textarea').forEach((el, index) => {
            const val = data.static[el.id || 'idx_' + index];
            if (val !== undefined) el.value = val;
            if (el.classList.contains('auto-height')) adjustHeight(el);
        });
        if (data.dynamic) {
            const groups = document.querySelectorAll('.field-group');
            data.dynamic.forEach(item => {
                if (groups[item.groupIdx]) addNewField(groups[item.groupIdx].querySelector('.add-field-btn'), item.value);
            });
        }
        return true;
    }

    function clearAllData() {
        if(confirm('Очистить опросник?')) {
            localStorage.removeItem(STORAGE_KEY);
            window.location.reload();
        }
    }

    window.onload = function() {
        if (!loadData()) {
            const now = new Date();
            const timeStr = now.toLocaleDateString('ru-RU') + " " + now.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('z_call').value = timeStr;
        }
        update();
    }

    function copyText() {
        const out = document.getElementById('output');
        out.select();
        document.execCommand('copy');
        const btn = document.querySelector('.btn-copy');
        btn.innerText = "СКОПИРОВАНО!";
        setTimeout(() => btn.innerText = "Скопировать", 1500);
    }
	function fixZ() {
    const input = document.getElementById('z_text');
    const fixedDiv = document.getElementById('z_fixed');
    const fixedValue = document.getElementById('z_value');
    const confirmBtn = document.getElementById('z_confirm_btn');
    const editBtn = document.getElementById('z_edit_btn');

    if (input.value.trim() !== "") {
        // Очищаем блок перед вставкой
        fixedValue.innerHTML = "";
        
        // Разбиваем текст на строки и оборачиваем каждую в span
        const lines = input.value.split('\n');
        lines.forEach(line => {
            const span = document.createElement('span');
            span.style.display = 'block';
            span.style.scrollSnapAlign = 'start'; // Каждая строка — точка остановки
            span.innerText = line || ' '; // Если строка пустая, ставим пробел
            fixedValue.appendChild(span);
        });

        input.style.display = 'none';
        confirmBtn.style.display = 'none';
        fixedDiv.style.display = 'block';
        editBtn.style.display = 'block';
        
        if (typeof update === "function") update();
    }
}
function editZ() {
    const input = document.getElementById('z_text');
    const fixedDiv = document.getElementById('z_fixed');
    const confirmBtn = document.getElementById('z_confirm_btn');
    const editBtn = document.getElementById('z_edit_btn');

    // Возвращаем всё как было
    input.style.display = 'block';
    confirmBtn.style.display = 'block';
    fixedDiv.style.display = 'none';
    editBtn.style.display = 'none';

    // Ставим курсор в поле, чтобы сразу можно было править
    input.focus();
}
;	
</script>
</body>
</html>