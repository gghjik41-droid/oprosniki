<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>–ü–°–û –ü–∞–Ω–µ–ª—å –û–ø—Ä–æ—Å–Ω–∏–∫–æ–≤</title>
    
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            padding-top: env(safe-area-inset-top); 
            background-color: #eceff1; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* –®–∞–ø–∫–∞ */
        .header-nav {
            background-color: #37474f;
            padding: 4px 8px;
            display: flex;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 100;
            position: sticky;
            top: 0;
        }

        .clear-btn { background-color: #b71c1c; color: white; border: none; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .pin-btn { background-color: #546e7a; color: white; border: none; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .pin-btn.active { background-color: #0288d1; }
        .nav-btn { background-color: #455a64; color: #cfd8dc; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; text-transform: uppercase; white-space: nowrap; }
        .nav-btn.active { background-color: #00c853; color: #fff; }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ 55/45 */
        .main-wrapper {
            display: flex;
            width: 100%;
            padding: 10px;
            padding-right: 25px; 
            gap: 15px;
            box-sizing: border-box;
            align-items: flex-start;
        }

        /* –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê (55%) */
        .form-side {
            flex: 0 0 55%;
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            padding: 20px;
            box-sizing: border-box;
        }

        /* –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê (45%) */
        .result-side {
            flex: 0 0 45%;
            position: sticky;
            top: 55px; 
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* –ë–ª–æ–∫ –∑–∞—è–≤–∫–∏ */
        .sticky-header {
            background: white;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            margin-bottom: 15px;
            position: sticky;
            top: 0; 
            z-index: 5;
        }
        .sticky-header.unpinned { position: static !important; border-bottom: none; }

        #z_text { width: 100%; min-height: 80px; padding: 8px; box-sizing: border-box; border: 1px solid #cfd8dc; border-radius: 4px; font-family: inherit; font-size: 14px; }
        
        #z_fixed { 
            display: none; 
            background: #f1f8e9; 
            padding: 10px; 
            border-radius: 6px; 
            border: 1px solid #c8e6c9; 
            line-height: 1.5em;
            max-height: 7.5em; 
            overflow-y: auto; 
            font-size: 13px; 
            color: #1b5e20; 
            white-space: pre-wrap;
            scroll-snap-type: y mandatory;
        }
        #z_value span { display: block; scroll-snap-align: start; }
        
        .btn-ok { margin-top: 8px; background: #4caf50; color: white; border: none; border-radius: 4px; padding: 10px; width: 100%; cursor: pointer; font-weight: bold; }

        #survey-frame {
            width: 100%;
            height: 500px; 
            border: none;
            display: block;
            overflow: hidden;
        }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç */
        .btn-copy { background-color: #1976d2; color: white; border: none; padding: 15px; border-radius: 4px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        #output { 
            width: 100%; 
            height: calc(100vh - 165px); 
            padding: 12px; 
            border-radius: 4px; 
            border: 1px solid #b0bec5; 
            font-family: 'Courier New', monospace; 
            font-size: 14px; 
            background: white; 
            white-space: pre-wrap; 
            resize: none; 
            box-sizing: border-box; 
            outline: none; 
        }
        
        #save-status { font-size: 11px; color: #78909c; text-align: right; margin-top: 2px; font-weight: bold; }

        @media (max-width: 900px) {
            .main-wrapper { flex-direction: column; padding-right: 10px; }
            .form-side, .result-side { flex: 0 0 100%; width: 100%; position: static; }
            #output { height: 400px; }
        }
    </style>
</head>
<body>

<div class="header-nav" id="menu">
    <button class="clear-btn" onclick="clearAllData()" title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë">‚úï</button>
    <button class="pin-btn active" id="master-pin-btn" onclick="togglePin()">üìå</button>
    
    <button class="nav-btn" onclick="openSurvey('short.html', this)">–ö–æ—Ä–æ—Ç–∫–∏–π</button>
    <button class="nav-btn" onclick="openSurvey('elderly.html', this)">–°—Ç–∞—Ä–∏–∫–∏</button>
    <button class="nav-btn" onclick="openSurvey('teens.html', this)">–ü–æ–¥—Ä–æ—Å—Ç–∫–∏</button>
    <button class="nav-btn" onclick="openSurvey('forest.html', this)">–õ–µ—Å</button>
    <button class="nav-btn" onclick="openSurvey('adults.html', this)">–í–∑—Ä–æ—Å–ª—ã–µ</button>
</div>

<div class="main-wrapper">
    <div class="form-side">
        <div class="sticky-header" id="master-sticky">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <label style="font-weight: bold; text-decoration: underline; font-size: 13px; color: #37474f;">–ó–ê–Ø–í–ö–ê</label>
                <button id="z_edit_btn" onclick="editZ()" style="display: none; background: #90a4ae; color: white; border: none; border-radius: 4px; padding: 2px 8px; font-size: 10px; cursor: pointer;">–ò–ó–ú–ï–ù–ò–¢–¨</button>
            </div>
            <textarea id="z_text" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞—è–≤–∫–∏..."></textarea>
            <div id="z_fixed"><div id="z_value"></div></div>
            <button id="z_confirm_btn" class="btn-ok" onclick="fixZ()">–û–ö</button>
        </div>

        <iframe src="short.html" id="survey-frame" scrolling="no"></iframe>
    </div>

    <div class="result-side">
        <button class="btn-copy" id="copy-btn" onclick="copyText()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
        <textarea id="output" readonly placeholder="–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø—Ä–æ—Å–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..."></textarea>
        <div id="save-status">–û–±–Ω–æ–≤–ª–µ–Ω–æ: --:--:--</div>
    </div>
</div>

<script>
    const ORDER = ['short', 'elderly', 'teens', 'forest', 'adults'];
    
    // –≠—Ç–æ —Å–µ—Ä–¥—Ü–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: –∑–¥–µ—Å—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –æ–±—â–∞—è —Å—Ç—Ä–æ–∫–∞ "–ü–æ–∑—ã–≤–Ω–æ–π + –í—Ä–µ–º—è"
    let globalCallsignData = localStorage.getItem('pso_global_callsign_data') || "";

    function togglePin() {
        const btn = document.getElementById('master-pin-btn');
        const header = document.getElementById('master-sticky');
        const isActive = btn.classList.toggle('active');
        header.classList.toggle('unpinned', !isActive);
    }

    function fixZ() {
        const val = document.getElementById('z_text').value.trim();
        if(!val) return;
        localStorage.setItem('pso_z_main', val);
        renderZ(val);
    }

    function renderZ(text) {
        const valDiv = document.getElementById('z_value');
        valDiv.innerHTML = "";
        text.split('\n').forEach(line => {
            const span = document.createElement('span');
            span.innerText = line || ' ';
            valDiv.appendChild(span);
        });
        document.getElementById('z_text').style.display = 'none';
        document.getElementById('z_confirm_btn').style.display = 'none';
        document.getElementById('z_fixed').style.display = 'block';
        document.getElementById('z_edit_btn').style.display = 'block';
    }

    function editZ() {
        document.getElementById('z_text').style.display = 'block';
        document.getElementById('z_confirm_btn').style.display = 'block';
        document.getElementById('z_fixed').style.display = 'none';
        document.getElementById('z_edit_btn').style.display = 'none';
    }

    // –†–∞—Å—Å—ã–ª–∫–∞ —Å—Ç—Ä–æ–∫–∏ –ø–æ–∑—ã–≤–Ω–æ–π+–≤—Ä–µ–º—è –≤–æ —Ñ—Ä–µ–π–º
    function broadcastData(value) {
        const frame = document.getElementById('survey-frame');
        if (frame && frame.contentWindow) {
            frame.contentWindow.postMessage({ type: 'set_global_data', value: value }, '*');
        }
    }

    function openSurvey(fileName, btn) {
        const frame = document.getElementById('survey-frame');
        frame.src = fileName;
        const buttons = document.querySelectorAll('.nav-btn');
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        localStorage.setItem('last_survey_file', fileName);
        
        // –ö–∞–∫ —Ç–æ–ª—å–∫–æ –≤–∫–ª–∞–¥–∫–∞ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å ‚Äî –æ—Ç–¥–∞–µ–º –µ–π —Ç–µ–∫—É—â–∏–π –ø–æ–∑—ã–≤–Ω–æ–π/–≤—Ä–µ–º—è
        frame.onload = () => broadcastData(globalCallsignData);
    }

    function clearAllData() {
        if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ñ–æ—Ä–º—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç?")) {
            localStorage.clear();
            location.reload();
        }
    }

    function updateFinalOutput() {
        let finalSections = [];
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—â—É—é —Å—Ç—Ä–æ–∫—É (–ü–æ–∑—ã–≤–Ω–æ–π –∏ –í—Ä–µ–º—è) –≤ —Å–∞–º—ã–π –≤–µ—Ä—Ö
        if (globalCallsignData) {
            finalSections.push(globalCallsignData.trim());
        }

        ORDER.forEach(source => {
            const savedText = localStorage.getItem('survey_text_' + source);
            if (savedText && savedText.trim() !== "") {
                finalSections.push(savedText.trim());
            }
        });

        document.getElementById('output').value = finalSections.join('\n\n');
        document.getElementById('save-status').innerText = "–û–±–Ω–æ–≤–ª–µ–Ω–æ: " + new Date().toLocaleTimeString();
    }

// –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –æ–±—â–∏—Ö –ø–æ–ª–µ–π
    let globalFields = JSON.parse(localStorage.getItem('pso_global_fields') || "{}");

    window.addEventListener('message', function(event) {
        if (event.data.type === 'survey_update') {
            localStorage.setItem('survey_text_' + event.data.source, event.data.text);
            updateFinalOutput();
        }

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–∑—ã–≤–Ω–æ–≥–æ (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞)
        if (event.data.type === 'sync_globals') {
            globalCallsignData = event.data.value;
            localStorage.setItem('pso_global_callsign_data', globalCallsignData);
            broadcastData(globalCallsignData, globalFields); // –†–∞—Å—Å—ã–ª–∞–µ–º –∏ –ø–æ–∑—ã–≤–Ω–æ–π, –∏ –ø–æ–ª—è
            updateFinalOutput();
        }

        // –ù–û–í–û–ï: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ–±—â–∏—Ö –ø–æ–ª–µ–π (–§–ò–û, –ó–¥–æ—Ä–æ–≤—å–µ –∏ —Ç.–¥.)
        if (event.data.type === 'sync_field') {
            globalFields[event.data.fieldId] = event.data.value;
            localStorage.setItem('pso_global_fields', JSON.stringify(globalFields));
            broadcastData(globalCallsignData, globalFields);
        }

        if (event.data.type === 'set_height') {
            const frame = document.getElementById('survey-frame');
            if (frame) frame.style.height = (event.data.height + 50) + 'px';
        }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Ä–∞—Å—Å—ã–ª–∫–∏, —á—Ç–æ–±—ã –æ–Ω–∞ –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∞ –∏ –æ–±—ä–µ–∫—Ç —Å –ø–æ–ª—è–º–∏
    function broadcastData(call, fields) {
        const frame = document.getElementById('survey-frame');
        if (frame && frame.contentWindow) {
            frame.contentWindow.postMessage({ 
                type: 'set_global_data', 
                value: call,
                fields: fields 
            }, '*');
        }
    };

    function copyText() {
        const out = document.getElementById('output');
        out.select();
        out.setSelectionRange(0, 99999);
        try {
            document.execCommand('copy');
            const btn = document.getElementById('copy-btn');
            btn.innerText = "–°–ö–û–ü–ò–†–û–í–ê–ù–û!";
            btn.style.backgroundColor = "#00c853";
            setTimeout(() => {
                btn.innerText = "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç";
                btn.style.backgroundColor = "#1976d2";
            }, 1200);
        } catch (err) {}
    }

    window.onload = function() {
        const savedZ = localStorage.getItem('pso_z_main');
        if(savedZ) renderZ(savedZ);
        const lastFile = localStorage.getItem('last_survey_file') || 'short.html';
        const buttons = document.querySelectorAll('.nav-btn');
        buttons.forEach(b => {
            if (b.getAttribute('onclick').includes(lastFile)) openSurvey(lastFile, b);
        });
        updateFinalOutput();
    };
</script>
</body>
</html>