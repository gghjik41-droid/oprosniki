<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Опросник (Короткий)</title>
<style>
    body { font-family: 'Segoe UI', sans-serif; background: white; margin: 0; padding: 10px; color: #333; overflow-x: hidden; }
    h2 { margin-top: 0; color: #211e1e; border-bottom: 2px solid #3b3535; padding-bottom: 8px; font-size: 18px; text-transform: uppercase; margin-bottom: 15px; }
    .field-group { margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; position: relative; }
    .hint { font-size: 12px; color: #2e7d32; margin-bottom: 4px; display: block; line-height: 1.3; background: #f1f8e9; padding: 4px 10px; border-left: 3px solid #4caf50; white-space: pre-wrap; }
    label { display: block; font-weight: 700; margin-bottom: 2px; font-size: 13px; color: #263238; text-decoration: underline; }
    input, .editable-field, textarea { width: 100%; padding: 8px 10px; border: 1px solid #cfd8dc; border-radius: 6px; box-sizing: border-box; font-size: 16px; background: #fafafa; display: block; outline: none; transition: all 0.2s; }
    input:focus, .editable-field:focus, textarea:focus { border-color: #4caf50; background: #fff; }
    .editable-field { min-height: 33px; line-height: 1.4; white-space: pre-wrap; overflow-wrap: break-word; cursor: text; }
    .editable-field:empty:before { content: attr(placeholder); color: #999; }
    .gender-toggle { display: flex; height: 30px; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; margin-left: 10px; }
    .gender-btn { border: none; background: #eceff1; color: #546e7a; cursor: pointer; padding: 0 10px; font-weight: bold; font-size: 12px; transition: all 0.2s; }
    .gender-btn.active { background: #4caf50; color: white; }
    .gender-btn:first-child { border-right: 1px solid #ccc; }
    .add-field-btn { font-size: 11px; color: #1976d2; cursor: pointer; text-decoration: none; display: inline-block; margin-top: 5px; font-weight: bold; }
    .dynamic-field-wrapper { position: relative; margin-top: 8px; display: flex; align-items: center; gap: 8px; }
    .dynamic-field { border-left: 3px dashed #1976d2 !important; background: #f9fbe7 !important; flex-grow: 1; }
    .remove-btn { color: #f44336; cursor: pointer; font-weight: bold; font-size: 20px; padding: 0 5px; user-select: none; }
    .section-title { background: #ffffff; color: #333; padding: 6px 16px; border-top: 3px solid #545454; border-bottom: 1px solid #eee; font-size: 15px; font-weight: bold; margin: 15px 0 0 0; display: block; }
</style>
</head>
<body oninput="syncEverything()">

<h2>Подростки (12-18 лет)</h2>

	<div class="field-group">
		<label>Позывной, дата и время прозвона:</label>
		<div style="display: flex; height: 38px; overflow: hidden; border: 1px solid #ccc; border-radius: 4px;">
			<input type="text" id="z_call" class="q-field-no-output" 
				   placeholder="Позывной ДД.ММ.ГГГГ ЧЧ:ММ" 
				   oninput="syncEverything()" 
				   style="flex: 1; border: none; padding: 0 10px; height: 100%; outline: none; box-sizing: border-box;">
			
			<button type="button" onclick="setCurrentTime()" title="Обновить время" 
					style="width: 38px; height: 100%; background: #4caf50; color: white; border: none; 
						   border-left: 1px solid #ccc; cursor: pointer; display: flex; 
						   align-items: center; justify-content: center; transition: background 0.2s;">
				<span style="font-size: 14px; margin-left: 2px;">▶</span>
			</button>
		</div>
	</div>

        <div class="section-title">Общая часть:</div>

	<div class="field-group">
		<span class="hint">ФИО заявителя, номер телефона в формате 81110000000, родство, доп. номер для связи.</span>
		<label>Прозвон заявителя:</label>
		<div id="g_name" 
		     class="editable-field q-field q-global" 
		     contenteditable="true" 
		     data-p="Прозвон заявителя: " 
		     oninput="syncField(this)" 
		     placeholder="Введите данные заявителя..."></div>
		<a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
	</div>

    <div class="field-group">
        <span class="hint">ФИО БВП (любая смена ФИО), дата рождения, возраст. Сверяем письменно!</span>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2px;">
            <label style="margin-bottom: 0;">Пропал{a}:</label>
            <div class="gender-toggle">
                <button type="button" id="sex_m" class="gender-btn active" onclick="setGender('m')">М</button>
                <button type="button" id="sex_f" class="gender-btn" onclick="setGender('f')">Ж</button>
            </div>
        </div>
        <div id="g_fio" class="editable-field q-field q-global" contenteditable="true" data-p="Пропал{a}: " oninput="syncField(this)"></div>
        <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
    </div>

    <div class="field-group">
        <span class="hint">Коротко: адрес пропажи (город, район, улица, № дома, № подъезда, № квартиры), дата, время.</span>
        <div id="g_event" class="editable-field q-field q-global" contenteditable="true" data-p="" oninput="syncField(this)" placeholder="Обстоятельства..."></div>
        <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
    </div>

    <div class="field-group">
        <span class="hint">Диагнозы, медикаменты, слух/зрение/ходьба, ориентирование во времени и пространстве, память.</span>
        <label>Здоровье:</label>
        <div id="g_health" class="editable-field q-field q-global" contenteditable="true" data-p="Здоровье: " oninput="syncField(this)"></div>
        <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
    </div>

    <div class="field-group">
        <span class="hint">Рост, телосложение, цвет и длина волос, цвет глаз, носит ли бороду/усы/очки.</span>
        <label>Приметы:</label>
        <div id="g_body" class="editable-field q-field q-global" contenteditable="true" data-p="Приметы: " oninput="syncField(this)"></div>
        <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
    </div>

    <div class="field-group">
        <span class="hint">Есть ли шрамы, тату, заметные родинки/родимые пятна, особенности зубов, походки, отсутствие пальцев и т. д.</span>
        <label>Особые:</label>
        <div id="g_special" class="editable-field q-field q-global" contenteditable="true" data-p="Особые: " oninput="syncField(this)"></div>
        <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
    </div>

    <div class="field-group">
        <span class="hint">Что было надето/обувь/головной убор (цвет, материал, надписи)</span>
        <label>Одежда:</label>
        <div id="g_clothes" class="editable-field q-field q-global" contenteditable="true" data-p="Одежда: " oninput="syncField(this)"></div>
        <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
    </div>

    <div class="field-group">
        <span class="hint">Что с собой (паспорт, наличные деньги, банковские карты, проездные, ключи, украшения), если нет, так и пишем «паспорт – нет, наличные - нет» и т.д.</span>
        <label>С собой:</label>
        <div id="g_with" class="editable-field q-field q-global" contenteditable="true" data-p="С собой: " oninput="syncField(this)"></div>
        <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
    </div>

    <div class="field-group">
        <span class="hint">Даже если остался дома. На кого зарегистрирована симка, марка и модель. Если сим на заявителя - попросить взять выписку звонков. В сети ли сейчас телефон. Когда был в сети в последний раз. Спрашиваем все номера.</span>
        <label>Телефон БВП:</label>
        <div id="g_namber" class="editable-field q-field q-global" contenteditable="true" data-p="Телефон БВП: " oninput="syncField(this)"></div>
        <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
    </div>

    <div class="field-group">
        <span class="hint">Где, с кем и сколько проживает/зарегистрирован{a}/пропал{a}.</span>
        <label>Проживает/прописан{a}/пропал{a}:</label>
        <div id="g_adress" class="editable-field q-field q-global" contenteditable="true" data-p="Проживает/прописан{a}/пропал{a}: " oninput="syncField(this)"></div>
        <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
    </div>

    <div class="field-group">
        <span class="hint">Пропадал{a} ли ранее, когда/как и где находили.</span>
        <div id="g_last" class="editable-field q-field q-global" contenteditable="true" data-p="" oninput="syncField(this)" placeholder="Ранее..."></div>
        <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
    </div>

    <div class="field-group">
        <span class="hint">ОБСТОЯТЕЛЬСТВА ПРОПАЖИ ПОДРОБНО Дата и время пропажи (во сколько стал недоступен/не отвечать на тел)! Что предпринимали для поиска (были на месте пропажи, звонили в БРНС).</span>
        <label>Подробности:</label>
        <div id="g_eventfull" class="editable-field q-field q-global" contenteditable="true" data-p="Подробности: " oninput="syncField(this)"></div>
        <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
    </div>

    <div class="field-group">
        <span class="hint">Полиция: ФИО заявителя, ОВД, контакты. Оговариваем срок подачи заявление в полицию до 3-х суток от момента поступлении заявки, в противном случае мы вынуждены будем отказать в поиске.</span>
        <label>ЗВП:</label>
        <div id="g_police" class="editable-field q-field q-global" contenteditable="true" data-p="ЗВП: " oninput="syncField(this)"></div>
        <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
    </div>

    <div class="section-title">Специальная часть:</div>

<div class="field-group">
    <span class="hint">Какие отношения с братьями/сестрами/родителями/что разрешено ребенку, какие существуют запреты/очень осторожно - родные ли родители. Родственники в других городах.</span>
    <label>Семья:</label>
    <div id="g_family" class="editable-field q-field q-global" contenteditable="true" data-p="Семья: " oninput="syncField(this)"></div>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Ссылки на профили, никнеймы.</span>
    <label>Соцсети:</label>
    <div id="g_soc" class="editable-field q-field q-global" contenteditable="true" data-p="Соцсети: " oninput="syncField(this)"></div>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Какой техникой пользуется, какая осталась дома (телефоны, планшеты, ноутбуки), если что-то осталось дома – есть ли у родителей к ней доступ.</span>
    <label>Гаджеты:</label>
    <div id="g_gadgets" class="editable-field q-field q-global" contenteditable="true" data-p="Гаджеты: " oninput="syncField(this)"></div>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Места, где бывает БВП.</span>
    <label>Места привязки:</label>
    <div id="g_place" class="editable-field q-field q-global" contenteditable="true" data-p="Места привязки: " oninput="syncField(this)"></div>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Обычные маршруты, транспорт, как оплачивает проезд.</span>
    <label>Маршруты:</label>
    <div id="g_way" class="editable-field q-field q-global" contenteditable="true" data-p="Маршруты: " oninput="syncField(this)"></div>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Где учится/прошлые места учебы. Как учится/есть ли проблемы/желание учиться.</span>
    <div id="g_school" class="editable-field q-field q-global" contenteditable="true" data-p="" oninput="syncField(this)" placeholder="Учеба..."></div>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Взаимоотношения с одноклассниками и учителями.</span>
    <div id="g_class" class="editable-field q-field q-global" contenteditable="true" data-p="" oninput="syncField(this)" placeholder="Одноклассники..."></div>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Как проводит свободное время/где/увлечения/интересы/секции/кружки.</span>
    <label>Свободное время:</label>
    <div id="g_hobby" class="editable-field q-field q-global" contenteditable="true" data-p="Свободное время: " oninput="syncField(this)"></div>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Друзья, подруги, их контакты.</span>
    <label>Круг общения:</label>
    <div id="g_friends" class="editable-field q-field q-global" contenteditable="true" data-p="Круг общения: " oninput="syncField(this)"></div>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Есть ли {love}.</span>
    <div id="g_love" class="editable-field q-field q-global" contenteditable="true" data-p="" oninput="syncField(this)" placeholder="Парень/девушка..."></div>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Состоит ли на учете в ОДН.</span>
    <label>Учет ОДН:</label>
    <div id="g_odn" class="editable-field q-field q-global" contenteditable="true" data-p="Учет ОДН: " oninput="syncField(this)"></div>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Обычный распорядок дня/время посещения занятий/во сколько ложится спать.</span>
    <label>Режим дня:</label>
    <div id="g_time" class="editable-field q-field q-global" contenteditable="true" data-p="Режим дня: " oninput="syncField(this)"></div>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Коммуникабельность, реакция на незнакомых людей/может ли уйти с незнакомым взрослым человеком.</span>
    <label>Характер:</label>
    <div id="g_character" class="editable-field q-field q-global" contenteditable="true" data-p="Характер: " oninput="syncField(this)"></div>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Что изменилось накануне пропажи: ссоры, конфликты, необычное.</span>
    <label>Накануне</label>
    <div id="g_before" class="editable-field q-field q-global" contenteditable="true" data-p="Накануне: " oninput="syncField(this)"></div>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Мысли о суициде – если нет, подробно, что дословно сказал заявитель, если да, из-за чего, как давно, что говорит о причинах, были ли ранее попытки/когда/способ, что говорит о способе/месте/времени.</span>
    <label>Суицид:</label>
    <div id="g_death" class="editable-field q-field q-global" contenteditable="true" data-p="Суицид: " oninput="syncField(this)"></div>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Курение, алкоголь, наркотики.</span>
    <div id="g_risks" class="editable-field q-field q-global" contenteditable="true" data-p="" oninput="syncField(this)" placeholder="Вредные привычки..."></div>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Контакты друзей/знакомых (обязательно хотя бы один доп. контакт для связи с заявителем!)</span>
    <label>Контакты:</label>
    <div id="g_contacts" class="editable-field q-field q-global" contenteditable="true" data-p="Контакты: " oninput="syncField(this)"></div>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Согласие на ориентировки, указание медпомощи (если необходимо). Объяснить, что информация будет размещена в интернете. </span>
    <label>Согласие на орки:</label>
    <div id="g_miss" class="editable-field q-field q-global" contenteditable="true" data-p="Согласие на орки: " oninput="syncField(this)"></div>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<script>
	var STORAGE_KEY = 'survey_cache_teens_v51'; 
    var SOURCE_ID = 'teens'; 
    var currentGender = 'm';
    var lastSentIndex = -1; // Для предотвращения лишних сообщений при движении мыши
    // lastSerializedData удален, так как он блокировал выдачу при инициализации

    var genderDictionary = {
        'm': { '{a}': '', '{а}': '' , '{ла}': '', '{love}': 'девушка', '{ела}':'ел' },
        'f': { '{a}': 'а', '{а}': 'а' , '{ла}': 'ла', '{love}': 'парень', '{ела}':'ла' }
    };

    function setGender(sex) {
        if (currentGender === sex) return; 
        currentGender = sex;
        var btnM = document.getElementById('sex_m');
        var btnF = document.getElementById('sex_f');
        if (btnM) btnM.className = (sex === 'm' ? 'gender-btn active' : 'gender-btn');
        if (btnF) btnF.className = (sex === 'f' ? 'gender-btn active' : 'gender-btn');
        
        updateLabelsOnPage();
        localStorage.setItem('pso_last_gender', sex);

        // Синхронизируем пол с родителем
        window.parent.postMessage({ 
            type: 'sync_field', 
            fieldId: 'pso_last_gender', 
            value: sex 
        }, '*');

        syncEverything();
    }

    function applyGender(text) {
        var result = text;
        var dict = genderDictionary[currentGender];
        for (var key in dict) {
            result = result.split(key).join(dict[key]);
        }
        return result;
    }

    window.addEventListener('message', function(event) {
        if (event.data.type === 'set_global_data') {
            // Синхронизация позывного/времени
            var callEl = document.getElementById('z_call');
            if (callEl && event.data.value !== undefined && callEl.value !== event.data.value) {
                callEl.value = event.data.value;
            }
            
            if (event.data.fields) {
                // Синхронизация пола
                if (event.data.fields['pso_last_gender'] && event.data.fields['pso_last_gender'] !== currentGender) {
                    currentGender = event.data.fields['pso_last_gender'];
                    var btnM = document.getElementById('sex_m');
                    var btnF = document.getElementById('sex_f');
                    if (btnM) btnM.className = (currentGender === 'm' ? 'gender-btn active' : 'gender-btn');
                    if (btnF) btnF.className = (currentGender === 'f' ? 'gender-btn active' : 'gender-btn');
                    updateLabelsOnPage();
                }

                // Синхронизация остальных полей
                for (var id in event.data.fields) {
                    var field = document.getElementById(id);
                    if (field && document.activeElement !== field) {
                        var newVal = event.data.fields[id];
                        if (field.tagName === 'DIV') {
                            if (field.innerText !== newVal) field.innerText = newVal;
                        } else {
                            if (field.value !== newVal) field.value = newVal;
                        }
                    }
                }
            }
            syncEverything();
            sendHeight();
        }
    });

    function syncField(el) {
        var val = (el.tagName === 'DIV' ? el.innerText : el.value);
        window.parent.postMessage({ type: 'sync_field', fieldId: el.id, value: val }, '*');
        syncEverything();
    }

    var syncTimer;
    function syncEverything() {
        clearTimeout(syncTimer);
        syncTimer = setTimeout(function() {
            var callEl = document.getElementById('z_call');
            var fullCall = callEl ? callEl.value : "";
            
            // Сначала обновляем глобальный позывной в родителе
            window.parent.postMessage({ type: 'sync_globals', value: fullCall }, '*');

            var payload = []; 
            var fields = document.querySelectorAll('.q-field');
            
            fields.forEach(function(el) {
                var val = (el.tagName === 'DIV' ? el.innerText : el.value).trim();
                // Не выводим позывной в список (он в шапке) и пустые поля
                if (val !== "" && !el.classList.contains('q-field-no-output') && el.id !== 'z_call') {
                    var rawPrefix = el.getAttribute('data-p') || "";
                    var prefix = applyGender(rawPrefix);
                    var label = prefix.replace(':', '').trim(); 
                    payload.push({ label: label, value: val });
                }
            });

            // Отправляем данные всегда при вызове этой функции без лишних проверок,
            // чтобы избежать "пустого поля" в индексе из-за ошибок инициализации.
            window.parent.postMessage({ 
                type: 'survey_update', 
                source: SOURCE_ID, 
                payload: payload 
            }, '*');

            saveLocal();
            sendHeight();
            initScrollSync(); 
        }, 150);
    }

    function addNewField(btn, val) {
        var wrapper = document.createElement('div');
        wrapper.className = 'dynamic-field-wrapper';
        var input = document.createElement('div');
        input.className = 'dynamic-field editable-field q-field';
        input.contentEditable = "true";
        input.setAttribute('data-dynamic', 'true');
        input.setAttribute('data-p', '');
        input.innerText = val || "";
        input.oninput = function() { syncEverything(); };
        var removeBtn = document.createElement('span');
        removeBtn.className = 'remove-btn';
        removeBtn.innerHTML = '×';
        removeBtn.onclick = function() { 
            wrapper.remove(); 
            syncEverything(); 
            initScrollSync(); 
        };
        wrapper.appendChild(input);
        wrapper.appendChild(removeBtn);
        btn.parentNode.insertBefore(wrapper, btn);
        sendHeight();
        initScrollSync(); 
    }

    function saveLocal() {
        var data = { static: {}, dynamic: [], gender: currentGender };
        document.querySelectorAll('input:not([data-dynamic]), .editable-field:not([data-dynamic])').forEach(function(el, i) {
            data.static[el.id || ('idx_' + i)] = (el.tagName === 'DIV' ? el.innerText : el.value);
        });
        document.querySelectorAll('[data-dynamic="true"]').forEach(function(el) {
            var groups = Array.prototype.slice.call(document.querySelectorAll('.field-group'));
            data.dynamic.push({ 
                groupIdx: groups.indexOf(el.closest('.field-group')), 
                value: el.innerText 
            });
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadLocal() {
        var raw = localStorage.getItem(STORAGE_KEY);
        var globalGender = localStorage.getItem('pso_last_gender');
        
        if (!raw) {
            if (globalGender) setGender(globalGender);
            return;
        }
        
        var data = JSON.parse(raw);
        setGender(globalGender || data.gender || 'm');

        document.querySelectorAll('input:not([data-dynamic]), .editable-field:not([data-dynamic])').forEach(function(el, i) {
            var val = data.static[el.id || ('idx_' + i)];
            if (val !== undefined) {
                if (el.tagName === 'DIV') el.innerText = val;
                else el.value = val;
            }
        });
        if (data.dynamic) {
            var groups = document.querySelectorAll('.field-group');
            data.dynamic.forEach(function(item) {
                if (groups[item.groupIdx]) addNewField(groups[item.groupIdx].querySelector('.add-field-btn'), item.value);
            });
        }
    }

    function updateLabelsOnPage() {
        document.querySelectorAll('label, .hint').forEach(function(el) {
            if (!el.hasAttribute('data-original')) el.setAttribute('data-original', el.innerHTML);
            el.innerHTML = applyGender(el.getAttribute('data-original'));
        });
    }

    function sendHeight() {
        var height = document.documentElement.offsetHeight || document.body.scrollHeight;
        window.parent.postMessage({ type: 'set_height', height: height }, '*');
    }

    // ИСПРАВЛЕННАЯ ФУНКЦИЯ: не стирает позывной
    function setCurrentTime() {
        var callEl = document.getElementById('z_call');
        if (callEl) {
            var currentVal = callEl.value || "";
            var now = new Date();
            var dateStr = now.toLocaleDateString('ru-RU');
            var timeStr = now.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'});
            var newStamp = dateStr + " " + timeStr;

            // Ищем первую цифру (начало даты)
            var firstDigitIndex = currentVal.search(/\d/);
            var callsignOnly = "";

            if (firstDigitIndex !== -1) {
                // Если цифры есть, берем текст ДО них (позывной)
                callsignOnly = currentVal.substring(0, firstDigitIndex).trim();
            } else {
                // Если цифр нет, значит всё поле — это позывной
                callsignOnly = currentVal.trim();
            }

            // Собираем: Позывной (если есть) + новая дата/время
            callEl.value = (callsignOnly ? callsignOnly + " " : "") + newStamp;
            syncEverything();
        }
    }

    function initScrollSync() {
        var outputIndex = 0;
        document.querySelectorAll('.q-field:not(.q-field-no-output)').forEach(function(el) {
            var val = (el.tagName === 'DIV' ? el.innerText : el.value).trim();
            if (val !== "" && el.id !== 'z_call') {
                el.setAttribute('data-index', outputIndex);
                outputIndex++;
            } else {
                el.removeAttribute('data-index');
            }
        });
    }

    document.addEventListener('mousemove', function(e) {
        var targetField = e.target.closest('.q-field[data-index]');
        if (targetField) {
            var idx = targetField.getAttribute('data-index');
            if (idx !== null && idx !== lastSentIndex) {
                lastSentIndex = idx;
                window.parent.postMessage({ type: 'sync_scroll', source: SOURCE_ID, index: idx }, '*');
            }
        }
    });

    window.onload = function() {
        loadLocal(); 
        updateLabelsOnPage(); 
        var callEl = document.getElementById('z_call');
        if (callEl && (!callEl.value || callEl.value.trim() === "")) {
            setCurrentTime();
        }
        syncEverything();
        setTimeout(function() {
            sendHeight();
            initScrollSync();
        }, 500);
    }
</script>
</body>
</html>