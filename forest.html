<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Опросник v4.5 ЭТАЛОН (Лес)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #eceff1; display: flex; height: 100vh; margin: 0; color: #333; }
        .container { display: flex; width: 100%; gap: 15px; padding: 15px; box-sizing: border-box; }
        .form-side { width: 55%; overflow-y: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .result-side { width: 45%; display: flex; flex-direction: column; gap: 10px; }
        
        h2 { margin-top: 0; color: #2e7d32; border-bottom: 2px solid #81c784; padding-bottom: 10px; font-size: 18px; text-transform: uppercase; }
        .hint { font-size: 11px; color: #1b5e20; margin-bottom: 5px; display: block; line-height: 1.4; background: #f1f8e9; padding: 6px 10px; border-left: 3px solid #4caf50; white-space: pre-wrap; }
        .section-title { background: #f1f8e9; padding: 8px 12px; font-weight: bold; margin: 25px 0 15px 0; border-left: 5px solid #2e7d32; font-size: 14px; }
        
        .field-group { margin-bottom: 25px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; position: relative; }
        label { display: block; font-weight: 700; margin-bottom: 4px; font-size: 13px; color: #263238; text-decoration: underline; }
        
        input, textarea { width: 100%; padding: 10px; border: 1px solid #cfd8dc; border-radius: 6px; box-sizing: border-box; font-size: 14px; background: #fafafa; display: block; }
        textarea.auto-height { min-height: 38px; height: 38px; resize: none; overflow: hidden; line-height: 1.4; }

        #z_text { min-height: 80px; resize: vertical; }
        .sticky-header { position: sticky; top: -25px; background: white; z-index: 10; padding-bottom: 10px; border-bottom: 2px solid #eee; margin-bottom: 15px; }
        #output { flex-grow: 1; padding: 15px; border-radius: 10px; border: 1px solid #b0bec5; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.2; background: #fff; white-space: pre-wrap; overflow-y: auto; }
        
        .add-field-btn { font-size: 10px; color: #1976d2; cursor: pointer; text-decoration: none; display: inline-block; margin-top: 5px; font-weight: bold; }
        .dynamic-field-wrapper { position: relative; margin-top: 10px; display: flex; align-items: center; gap: 5px; }
        .dynamic-field { border-left: 2px dashed #1976d2 !important; background: #f1f8e9 !important; flex-grow: 1; }
        .remove-btn { color: #f44336; cursor: pointer; font-weight: bold; font-size: 18px; padding: 0 5px; user-select: none; }

        .buttons { display: flex; gap: 10px; align-items: center; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-copy { background: #1976d2; color: white; }
        .btn-clear { background: #f44336; color: white; width: 100px; flex: none; }
        #save-status { font-size: 11px; color: #999; margin-left: auto; }
    </style>
</head>
<body>

<div class="container">
    <div class="form-side" id="form_container">
        <div class="sticky-header">
            <div class="field-group" style="border:none; margin:0;">
                <label>ЗАЯВКА</label>
                <textarea id="z_text" data-p="" placeholder="Введите текст заявки..." oninput="update()"></textarea>
                <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
            </div>
        </div>

        <h2>Лес</h2>

        <div class="field-group">
            <label>Позывной, дата и время прозвона:</label>
            <input type="text" id="z_call" data-p=" " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="section-title">Общая часть:</div>

        <div class="field-group">
            <span class="hint">ФИО заявителя, номер телефона в формате 81110000000, родство
Дополнительный номер для связи с заявителем (соседи, друзья, родственники).</span>
            <label>Прозвон заявителя:</label>
            <textarea class="auto-height" data-p="Прозвон заявителя: " oninput="adjustAndSync(this)"></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">ФИО БВП (любая смена ФИО). Сверяем ФИО письменно!
Дата рождения и возраст. Сверяем письменно!</span>
            <label>Пропал:</label>
            <textarea class="auto-height" data-p="Пропал: " oninput="adjustAndSync(this)"></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Коротко об обстоятельствах: адрес пропажи (город, район, улица, № дома, № подъезда), дата, время.</span>
            <textarea class="auto-height" data-p="" oninput="adjustAndSync(this)" placeholder="Обстоятельства..."></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Как зовут дома (работа на отклик).</span>
            <label>Дома зовут:</label>
            <input type="text" data-p="Дома зовут: " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Здоровье/медикаменты/что будет, если не принять. Есть ли диагноз/какой/инвалидность. Как проявляется заболевание. Как ориентируется в пространстве. Как слышит/видит/ходит, ориентир во времени и пространстве, память.</span>
            <label>Здоровье:</label>
            <textarea class="auto-height" data-p="Здоровье: " oninput="adjustAndSync(this)"></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Использует ли для ходьбы трость или палку, скорость ходьбы, сколько может пройти по времени, по расстоянию.</span>
            <textarea class="auto-height" data-p="" oninput="adjustAndSync(this)" placeholder="Особенности передвижения..."></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Приметы (рост, телосложение, цвет и длина волос, цвет глаз, носит ли бороду/усы/очки).</span>
            <label>приметы:</label>
            <input type="text" data-p="приметы: " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Особые (есть ли шрамы, тату, заметные родинки/родимые пятна, особенности зубов, походки, отсутствие пальцев и тп).</span>
            <label>Особые:</label>
            <input type="text" data-p="Особые: " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Одежда/обувь/головной убор (цвет, материал, надписи), размер обуви!</span>
            <label>Одежда:</label>
            <input type="text" data-p="Одежда: " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Что с собой (паспорт, наличные деньги, банковские карты, проездные, ключи, украшения, компас, навигатор, вода/еда, нож). Если с собой пакет, ведерко – обязательно их размер, цвет, подробное описание. Курит ли, могут ли быть с собой спички/зажигалка, какие сигареты (марка, описание)?</span>
            <label>С собой:</label>
            <textarea class="auto-height" data-p="С собой: " oninput="adjustAndSync(this)"></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Телефон потеряшки, на кого зарегистрирована симка, марка и модель (кнопка или смартфон), когда заряжал, как долго держит зарядку, как давно не отвечает на звонки или недоступен, если на связи – во сколько созванивались в прошлый раз, строго попросить больше не звонить, что дословно говорил при последнем общении по телефону, узнать, какими мессенджерами пользуется.</span>
            <label>Телефон БВП:</label>
            <input type="text" data-p="Телефон БВП " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Где и с кем, сколько по времени проживает/зарегистрирован(а)/пропал(а).</span>
            <label>Проживает/прописан/пропал:</label>
            <input type="text" data-p="Проживает/прописан/пропал: " oninput="update()">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Пропадал(а) ли ранее, когда/как и где находили.</span>
            <textarea class="auto-height" data-p="" oninput="adjustAndSync(this)" placeholder="Ранее пропадал..."></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">ОБСТОЯТЕЛЬСТВА ПРОПАЖИ подробно!!! Когда ушел в лес, когда должен был вернуться, что говорил перед выходом, ближайшие снт, точка входа, координаты.</span>
            <label>Подробности:</label>
            <textarea class="auto-height" data-p="Подробности: " oninput="adjustAndSync(this)"></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Полиция: ФИО заявителя в полицию, дата подачи заявления, название ОВД (адрес ОВД), телефон дежурной части, номер талона, номер КУСП, если есть – телефон оперативного сотрудника. Если у заявителя нет этой информации – просим узнать. Оговариваем срок подачи заявление в полицию до 3-х суток от момента поступлении заявки...</span>
            <label>ЗВП:</label>
            <textarea class="auto-height" data-p="ЗВП " oninput="adjustAndSync(this)"></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="section-title">Специальная часть (ЛЕС):</div>

        <div class="field-group">
            <span class="hint">Как добирается до дачи (места входа в лес) – подробный маршрут/каким транспортом, пользуется ли соцкартой, проездным или покупает билет на станции. Если потеряшка на авто, необходимо выяснить: марку, номер и цвет автомобиля, где нашли автомобиль.</span>
            <textarea class="auto-height" data-p="" oninput="adjustAndSync(this)" placeholder="Маршрут до леса / Авто..."></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Способность потеряшки ориентироваться на местности.</span>
            <textarea class="auto-height" data-p="" oninput="adjustAndSync(this)" placeholder="Ориентирование..."></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Навыки выживания. Что будет делать в ночное время суток: сможет развести костер, построить шалаш или лежанку.</span>
            <textarea class="auto-height" data-p="" oninput="adjustAndSync(this)" placeholder="Навыки выживания..."></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Потеряшке знаком лес, в который он ушел? Как часто в него ходит?</span>
            <textarea class="auto-height" data-p="" oninput="adjustAndSync(this)" placeholder="Знание леса..."></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">За чем пошел в лес. За какими грибами, ягодами ходит.</span>
            <textarea class="auto-height" data-p="" oninput="adjustAndSync(this)" placeholder="Цель похода..."></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Известно ли, куда он обычно ходит (может кто-то подробно описать это место, показать на месте).</span>
            <textarea class="auto-height" data-p="" oninput="adjustAndSync(this)" placeholder="Типичные места..."></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Кто есть на месте пропажи и их контакты: родственников, полиции, ПСО</span>
            <textarea class="auto-height" data-p="" oninput="adjustAndSync(this)" placeholder="Кто на месте..."></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Есть ли на въезде в СНТ шлагбаум/свободный ли проезд.</span>
            <textarea class="auto-height" data-p="" oninput="adjustAndSync(this)" placeholder="Шлагбаум/Проезд..."></textarea>
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="field-group">
            <span class="hint">Согласие на ориентировку. мед.помощь (при необходимости). Пояснить родным, что информация будет размещена в интернете.</span>
            <label>Согласие на орки:</label>
            <input type="text" data-p="Согласие на орки - " oninput="update()" placeholder="Да/Нет">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>
    </div>

    <div class="result-side">
        <div class="buttons">
            <button class="btn-copy" onclick="copyText()">Скопировать</button>
            <button class="btn-clear" onclick="clearAllData()">Очистить</button>
            <span id="save-status">Сохранено</span>
        </div>
        <textarea id="output" readonly></textarea>
    </div>
</div>

<script>
    const STORAGE_KEY = 'pso_survey_forest_v45';

    function adjustHeight(el) {
        el.style.height = '38px';
        el.style.height = (el.scrollHeight) + 'px';
    }

    function adjustAndSync(el) {
        adjustHeight(el);
        update();
    }

    function addNewField(btn, val = "") {
        const wrapper = document.createElement('div');
        wrapper.className = 'dynamic-field-wrapper';
        const input = document.createElement('textarea');
        input.className = 'dynamic-field auto-height';
        input.placeholder = 'Дополнение...';
        input.setAttribute('data-dynamic', 'true');
        input.setAttribute('data-p', '');
        input.value = val;
        input.oninput = function() { adjustAndSync(this); };
        const removeBtn = document.createElement('span');
        removeBtn.className = 'remove-btn';
        removeBtn.innerHTML = '×';
        removeBtn.onclick = function() { wrapper.remove(); update(); };
        wrapper.appendChild(input);
        wrapper.appendChild(removeBtn);
        btn.parentNode.insertBefore(wrapper, btn);
        if (!val) input.focus();
        adjustHeight(input);
    }

    function update() {
        let lines = [];
        const zText = document.getElementById('z_text').value.trim();
        if (zText !== "") lines.push("ЗАЯВКА\n" + zText + "\n");

        document.querySelectorAll('.form-side input, .form-side textarea').forEach(el => {
            if (el.id === 'z_text' || el.id === 'output') return;
            const val = el.value.trim();
            if (val !== "") {
                const prefix = el.getAttribute('data-p') || "";
                if (el.id === 'z_call') {
                    lines.push(prefix + val + "\n");
                } else {
                    lines.push(prefix + val);
                }
            }
        });

        document.getElementById('output').value = lines.join('\n').replace(/\n{3,}/g, '\n\n').trim();
        saveData();
    }

    function saveData() {
        const data = { static: {}, dynamic: [] };
        document.querySelectorAll('input, textarea').forEach((el, index) => {
            if (el.id === 'output') return;
            if (el.hasAttribute('data-dynamic')) {
                const parentGroup = el.closest('.field-group');
                const groupIdx = Array.from(document.querySelectorAll('.field-group')).indexOf(parentGroup);
                data.dynamic.push({ groupIdx: groupIdx, value: el.value });
            } else {
                data.static[el.id || 'idx_' + index] = el.value;
            }
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        document.getElementById('save-status').innerText = "Сохранено " + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function loadData() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const data = JSON.parse(raw);
        document.querySelectorAll('input, textarea').forEach((el, index) => {
            const val = data.static[el.id || 'idx_' + index];
            if (val !== undefined) el.value = val;
            if (el.classList.contains('auto-height')) adjustHeight(el);
        });
        if (data.dynamic) {
            const groups = document.querySelectorAll('.field-group');
            data.dynamic.forEach(item => {
                if (groups[item.groupIdx]) addNewField(groups[item.groupIdx].querySelector('.add-field-btn'), item.value);
            });
        }
        return true;
    }

    function clearAllData() {
        if(confirm('Очистить опросник?')) {
            localStorage.removeItem(STORAGE_KEY);
            window.location.reload();
        }
    }

    window.onload = function() {
        if (!loadData()) {
            const now = new Date();
            const timeStr = now.toLocaleDateString('ru-RU') + " " + now.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('z_call').value = timeStr;
        }
        update();
    }

    function copyText() {
        const out = document.getElementById('output');
        out.select();
        document.execCommand('copy');
        const btn = document.querySelector('.btn-copy');
        btn.innerText = "СКОПИРОВАНО!";
        setTimeout(() => btn.innerText = "Скопировать", 1500);
    }
</script>
</body>
</html>