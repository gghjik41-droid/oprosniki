<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Опросник (Шаблон)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: white; margin: 0; padding: 15px; color: #333; overflow-x: hidden; }
        h2 { margin-top: 0; color: #211e1e; border-bottom: 2px solid #3b3535; padding-bottom: 10px; font-size: 18px; text-transform: uppercase; }
        .field-group { margin-bottom: 25px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; position: relative; }
        .hint { font-size: 12px; color: #2e7d32; margin-bottom: 5px; display: block; line-height: 1.4; background: #f1f8e9; padding: 6px 10px; border-left: 3px solid #4caf50; white-space: pre-wrap; }
        label { display: block; font-weight: 700; margin-bottom: 4px; font-size: 13px; color: #263238; text-decoration: underline; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #cfd8dc; border-radius: 6px; box-sizing: border-box; font-size: 16px; background: #fafafa; display: block; outline: none; transition: border 0.2s; }
        input:focus, textarea:focus { border-color: #4caf50; }
        textarea.auto-height { min-height: 38px; height: 38px; resize: none; overflow: hidden; line-height: 1.4; }
        .add-field-btn { font-size: 11px; color: #1976d2; cursor: pointer; text-decoration: none; display: inline-block; margin-top: 8px; font-weight: bold; }
        .dynamic-field-wrapper { position: relative; margin-top: 10px; display: flex; align-items: center; gap: 8px; }
        .dynamic-field { border-left: 3px dashed #1976d2 !important; background: #f9fbe7 !important; flex-grow: 1; }
        .remove-btn { color: #f44336; cursor: pointer; font-weight: bold; font-size: 20px; padding: 0 5px; user-select: none; }
		.section-title {
    background: #ffffff;         /* Белый фон */
    color: #333;                 /* Цвет текста */
    padding: 8px 16px;           /* Узкие вертикальные отступы, стандартные горизонтальные */
    border-top: 3px solid #545454; /* Акцентная оранжевая полоса сверху */
    border-left: 1px solid #ddd;   /* Тонкая рамка по бокам */
    border-right: 1px solid #ddd;
    border-bottom: 1px solid #eee; /* Едва заметный низ */
    box-shadow: 0 1px 2px rgba(0,0,0,0.05); /* Легкая тень для объема */
    border-radius: 4px 4px 0 0;  /* Скругление только верхних углов */
    font-size: 15px;             /* Читабельный, но компактный шрифт */
    font-weight: bold;
    margin: 20px 0 0 0;          /* Отступ сверху есть, снизу — вплотную к контенту */
    display: block;              /* Растягивается на всю ширину */
    box-sizing: border-box;      /* Чтобы рамки не вылезали за края */
}
    </style>
</head>
<body oninput="syncEverything()">





        <h2>Лес</h2>

        <div class="field-group">
            <label>Позывной, дата и время прозвона:</label>
            <input type="text" id="z_call" class="q-field-no-output" data-p="">
            <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
        </div>

        <div class="section-title">Общая часть:</div>

<div class="field-group">
    <span class="hint">ФИО заявителя, номер телефона в формате 81110000000, родство, доп. номер для связи.</span>
    <label>Прозвон заявителя:</label>
    <textarea id="g_name" class="auto-height q-field q-global" data-p="Прозвон заявителя: " oninput="syncField(this)"></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">ФИО БВП (любая смена ФИО), дата рождения, возраст. Сверяем письменно!</span>
    <label>Пропал:</label>
    <textarea id="g_fio" class="auto-height q-field q-global" data-p="Пропал: " oninput="syncField(this)"></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Коротко: адрес пропажи (город, СНТ, № дома), дата, время.</span>
    <textarea id="g_event" class="auto-height q-field q-global" data-p="" oninput="syncField(this)" placeholder="Обстоятельства..."></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Диагнозы, медикаменты, слух/зрение/ходьба, ориентирование во времени и пространстве, память.</span>
    <label>Здоровье:</label>
    <textarea id="g_health" class="auto-height q-field q-global" data-p="Здоровье: " oninput="syncField(this)"></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Использует ли для ходьбы трость или палку, скорость ходьбы, сколько может пройти по времени, по расстоянию.</span>
    <textarea id="g_walk" class="auto-height q-field q-global" data-p="" oninput="syncField(this)" placeholder="Особенности передв..."></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Как зовут дома (для работы на отклик).</span>
    <label>Дома зовут:</label>
    <textarea id="g_nick" class="auto-height q-field q-global" data-p="Дома зовут: " oninput="syncField(this)"></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Рост, телосложение, цвет и длина волос, цвет глаз, носит ли бороду/усы/очки.</span>
    <label>Приметы:</label>
    <textarea id="g_body" class="auto-height q-field q-global" data-p="Приметы: " oninput="syncField(this)"></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Есть ли шрамы, тату, заметные родинки/родимые пятна, особенности зубов, походки, отсутствие пальцев и т. д.</span>
    <label>Особые:</label>
    <textarea id="g_special" class="auto-height q-field q-global" data-p="Особые: " oninput="syncField(this)"></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Что было надето/обувь/головной убор (цвет, материал, надписи)</span>
    <label>Одежда:</label>
    <textarea id="g_clothes" class="auto-height q-field q-global" data-p="Одежда: " oninput="syncField(this)"></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Что с собой (паспорт, наличные деньги, банковские карты, проездные, ключи, украшения, компас, навигатор, вода/еда, нож). Если с собой пакет, ведерко – обязательно их размер и цвет. Как часто и сколько дают карманных денег, копит ли, пропадало ли что-либо из дома.</span>
    <label>С собой:</label>
    <textarea id="g_with" class="auto-height q-field q-global" data-p="С собой: " oninput="syncField(this)"></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Даже если остался дома. На кого зарегистрирована симка, марка и модель. Если сим на заявителя - попросить взять выписку звонков. В сети ли сейчас телефон. Когда был в сети в последний раз. Спрашиваем все номера.</span>
    <label>Телефон БВП:</label>
    <textarea id="g_namber" class="auto-height q-field q-global" data-p="Телефон БВП: " oninput="syncField(this)"></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">ОБСТОЯТЕЛЬСТВА ПРОПАЖИ ПОДРОБНО Дата и время пропажи (во сколько стал недоступен/не отвечать на тел)! Что предпринимали для поиска (были на месте пропажи, звонили в БРНС).</span>
    <label>Подробности:</label>
    <textarea id="g_eventfull" class="auto-height q-field q-global" data-p="Подробности: " oninput="syncField(this)"></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Полиция: ФИО заявителя, ОВД, контакты. Оговариваем срок подачи заявление в полицию до 3-х суток от момента поступлении заявки, в противном случае мы вынуждены будем отказать в поиске.</span>
    <label>ЗВП:</label>
    <textarea id="g_police" class="auto-height q-field q-global" data-p="ЗВП: " oninput="syncField(this)"></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="section-title">Специальная часть:</div>

<div class="field-group">
    <span class="hint">Известно ли, куда он обычно ходит (может кто-то подробно описать это место, показать на месте).</span>
    <label>Места привязки:</label>
    <textarea id="g_place" class="auto-height q-field q-global" data-p="Места привязки: " oninput="syncField(this)"></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Как добирается до дачи (места входа в лес) – подробный маршрут/каким транспортом, пользуется ли соцкартой, проездным или покупает билет на станции. Если потеряшка на авто, необходимо выяснить: марку, номер и цвет автомобиля, где нашли автомобиль.</span>
    <label>Маршруты:</label>
    <textarea id="g_way" class="auto-height q-field q-global" data-p="Маршруты: " oninput="syncField(this)"></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Способность ориентироваться на местности. Навыки выживания. Что будет делать в ночное время суток: сможет развести костер, построить шалаш или лежанку.</span>
    <textarea id="g_alive" class="auto-height q-field q-global" data-p="" oninput="syncField(this)" placeholder="Навыки выживания..."></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">БВП знаком лес, в который он ушел? Как часто в него ходит?</span>
    <textarea id="g_fores" class="auto-height q-field q-global" data-p="" oninput="syncField(this)" placeholder="Знание леса..."></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">За чем пошел в лес. За какими грибами, ягодами ходит.</span>
    <textarea id="g_berries" class="auto-height q-field q-global" data-p="" oninput="syncField(this)" placeholder="Цель похода..."></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Кто есть на месте пропажи и их контакты: родственников, полиции, ПСО</span>
    <textarea id="g_spot" class="auto-height q-field q-global" data-p="" oninput="syncField(this)" placeholder="На месте..."></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Есть ли на въезде в СНТ/лес шлагбаум, камера, охрана. Можно ли проехать на пузотерке.</span>
    <textarea id="g_gate" class="auto-height q-field q-global" data-p="" oninput="syncField(this)" placeholder="Шлагбаум/Проезд..."></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Контакты друзей/знакомых (обязательно хотя бы один доп. контакт для связи с заявителем!)</span>
    <label>Контакты:</label>
    <textarea id="g_contacts" class="auto-height q-field q-global" data-p="Контакты: " oninput="syncField(this)"></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>

<div class="field-group">
    <span class="hint">Согласие на ориентировки, указание медпомощи (если необходимо). Объяснить, что информация будет размещена в интернете.</span>
    <label>Согласие на орки:</label>
    <textarea id="g_miss" class="auto-height q-field q-global" data-p="Согласие на орки: " oninput="syncField(this)"></textarea>
    <a class="add-field-btn" onclick="addNewField(this)">[+] ДОБАВИТЬ поле вне вопроса</a>
</div>









<script>
    // --- НАСТРОЙКИ ШАБЛОНА ---
    const STORAGE_KEY = 'survey_cache_forest_v45'; // Меняйте для каждой вкладки
    const SOURCE_ID = 'forest'; // Должно совпадать с тем, что ждет index.html (short, elderly, forest, teens)

    // 1. СЛУШАТЕЛЬ ИЗ ИНДЕКСА (Прием данных от других вкладок)
    window.addEventListener('message', function(event) {
        if (event.data.type === 'set_global_data') {
            // Синхронизация позывного/времени
            const callEl = document.getElementById('z_call');
            if (callEl && event.data.value && callEl.value !== event.data.value) {
                callEl.value = event.data.value;
            }
            // Синхронизация общих полей (ФИО, Здоровье и т.д.)
            if (event.data.fields) {
                for (let id in event.data.fields) {
                    const field = document.getElementById(id);
                    if (field && field.value !== event.data.fields[id]) {
                        field.value = event.data.fields[id];
                        if (field.classList.contains('auto-height')) adjustHeight(field);
                    }
                }
            }
        }
    });

    // 2. КНОПКА "▶" (Обновить только время, сохранив позывной)
    function setCurrentTime() {
        const el = document.getElementById('z_call');
        if (!el) return;

        const now = new Date();
        const dateStr = now.toLocaleDateString('ru-RU');
        const timeStr = now.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'});
        const newDateTime = `${dateStr} ${timeStr}`;

        const dateTimePattern = /\d{2}\.\d{2}\.\d{4}\s\d{2}:\d{2}/;
        const match = el.value.match(dateTimePattern);

        if (match) {
            el.value = el.value.replace(dateTimePattern, newDateTime);
        } else {
            const currentVal = el.value.trim();
            el.value = (currentVal ? currentVal + " " : "") + newDateTime;
        }

        syncEverything(); 
    }

    // 3. СИНХРОНИЗАЦИЯ ОБЩИХ ПОЛЕЙ (Вызывается через oninput="syncField(this)")
    function syncField(el) {
        window.parent.postMessage({
            type: 'sync_field',
            fieldId: el.id,
            value: el.value
        }, '*');
        syncEverything();
    }

    // 4. ГЛАВНАЯ СИНХРОНИЗАЦИЯ (Сборка текста для отчета)
    let syncTimer;
    function syncEverything() {
        clearTimeout(syncTimer);
        syncTimer = setTimeout(() => {
            const fullCall = document.getElementById('z_call')?.value || "";

            // Отправляем позывной в Индекс
            window.parent.postMessage({ type: 'sync_globals', value: fullCall }, '*');

            // Собираем все поля q-field в текст (кроме тех, что с классом q-field-no-output)
            let lines = [];
            document.querySelectorAll('.q-field').forEach(el => {
                const val = el.value.trim();
                if (val !== "" && !el.classList.contains('q-field-no-output')) {
                    const prefix = el.getAttribute('data-p') || "";
                    lines.push(prefix + val);
                }
            });

            // Отправляем текст вкладки в Индекс
            window.parent.postMessage({
                type: 'survey_update',
                source: SOURCE_ID, 
                text: lines.join('\n')
            }, '*');

            saveLocal();
        }, 150);
    }

    // 5. ДИНАМИЧЕСКИЕ ПОЛЯ [+]
    function addNewField(btn, val = "") {
        const wrapper = document.createElement('div');
        wrapper.className = 'dynamic-field-wrapper';
        const input = document.createElement('textarea');
        input.className = 'dynamic-field auto-height q-field';
        input.placeholder = 'Дополнительно...';
        input.setAttribute('data-dynamic', 'true');
        input.setAttribute('data-p', '');
        input.value = val;
        input.oninput = function() { adjustHeight(this); syncEverything(); };
        const removeBtn = document.createElement('span');
        removeBtn.className = 'remove-btn';
        removeBtn.innerHTML = '×';
        removeBtn.onclick = function() { wrapper.remove(); syncEverything(); };
        wrapper.appendChild(input);
        wrapper.appendChild(removeBtn);
        btn.parentNode.insertBefore(wrapper, btn);
        if (!val) input.focus();
        adjustHeight(input);
    }

    // 6. СОХРАНЕНИЕ И ЗАГРУЗКА
    function saveLocal() {
        const data = { static: {}, dynamic: [] };
        document.querySelectorAll('input:not([data-dynamic]), textarea:not([data-dynamic])').forEach((el, i) => {
            data.static[el.id || 'idx_'+i] = el.value;
        });
        document.querySelectorAll('[data-dynamic="true"]').forEach(el => {
            const parentGroup = el.closest('.field-group');
            const groups = Array.from(document.querySelectorAll('.field-group'));
            data.dynamic.push({ groupIdx: groups.indexOf(parentGroup), value: el.value });
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadLocal() {
        // Загрузка позывного
        const globalCall = localStorage.getItem('pso_global_callsign_data');
        if (document.getElementById('z_call') && globalCall) {
            document.getElementById('z_call').value = globalCall;
        }

        // Загрузка общих полей (ФИО и т.д.)
        const globalFields = JSON.parse(localStorage.getItem('pso_global_fields') || "{}");
        for (let id in globalFields) {
            const field = document.getElementById(id);
            if (field) field.value = globalFields[id];
        }

        // Загрузка специфичных полей этой вкладки
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const data = JSON.parse(raw);
        document.querySelectorAll('input:not([data-dynamic]), textarea:not([data-dynamic])').forEach((el, i) => {
            if (el.id !== 'z_call' && !el.classList.contains('q-global')) {
                const val = data.static[el.id || 'idx_'+i];
                if (val !== undefined) el.value = val;
            }
            if (el.classList.contains('auto-height')) adjustHeight(el);
        });
        if (data.dynamic) {
            const groups = document.querySelectorAll('.field-group');
            data.dynamic.forEach(item => {
                if (groups[item.groupIdx]) addNewField(groups[item.groupIdx].querySelector('.add-field-btn'), item.value);
            });
        }
        return true;
    }

    // 7. СЕРВИСНЫЕ ФУНКЦИИ
    function adjustHeight(el) {
        el.style.height = '38px';
        el.style.height = (el.scrollHeight) + 'px';
        sendHeight();
    }

    function sendHeight() {
        const height = document.documentElement.offsetHeight || document.body.scrollHeight;
        window.parent.postMessage({ type: 'set_height', height: height }, '*');
    }

    window.onload = function() {
        loadLocal();
        const callEl = document.getElementById('z_call');
        if (callEl && (!callEl.value || callEl.value.trim() === "")) {
            const now = new Date();
            callEl.value = now.toLocaleDateString('ru-RU') + " " + now.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'});
            localStorage.setItem('pso_global_callsign_data', callEl.value);
        }
        syncEverything();
        setTimeout(sendHeight, 300);
    }
</script>
</body>
</html>